package svcs

import (
	"os"

	"github.com/spf13/viper"
	"mmesh.dev/m-node/internal/app/node/bgp"
	"mmesh.dev/m-lib/pkg/runtime"
	"x6a.dev/pkg/xlog"
)

func BGPAgent(w *runtime.Wrkr) {
	xlog.Infof("Started worker %s", w.Name)
	w.Running = true

	go func() {
		if !viper.GetBool("routing.bgp.enabled") {
			xlog.Info("BGP agent not enabled")
			return
		}

		if err := bgp.Start(); err != nil {
			xlog.Alertf("Unable to start BGP agent: %v", err)
			os.Exit(1)
		}
	}()

	<-w.QuitChan

	if viper.GetBool("routing.bgp.enabled") {
		if err := bgp.Stop(); err != nil {
			xlog.Errorf("Unable to stop BGP agent: %v", err)
		}
	}

	w.WG.Done()
	w.Running = false
	xlog.Infof("Stopped worker %s", w.Name)
}
