version: '3'

silent: true

vars:
  NAME: m-node
  ORG: mmesh
  DOMAIN: mmesh.dev
  PROJECT: mmesh
  GITHUB_PKG: 'github.com/{{.ORG}}/{{.NAME}}'
  PREFIX: {sh: pwd}
  PROJECT_DIR: '{{.PREFIX}}/../..'
  DIST_DIR: '{{.PREFIX}}/_dist'
  VERSION: {sh: cat VERSION}
  LOCAL_UID: {sh: id -u}
  LOCAL_GID: {sh: id -g}
  PKG_REPO: 'mmesh'
  PKG_REPO_DEV: 'mmesh-dev'
  GS_BUCKET: 'gs://mmesh-io'

env:
  PKG: '{{.DOMAIN}}/{{.PROJECT}}'
  VERSION: {sh: cat VERSION}
  VERSION_DATE: {sh: date -u +%Y%m%d%H%M%S}
  GO_VERSION: {sh: go version | cut -f 3 -d ' '}
  GO111MODULE: on
  CGO_ENABLED: 0
  #GOPRIVATE: 'mmesh.dev/m-api-go,mmesh.dev/m-lib'

tasks:
  _build-all:
    cmds:
      - task: _build-node

  _build-node:
    cmds:
      - task: golang:go-generate
      - task: golang:go-fmt
      - task: golang:go-verify-vendor
      # - task: golang:go-vet
      # - task: golang:golangci-lint
      - goreleaser build -f build/ci/goreleaser/node.yml --snapshot --rm-dist

  build-all:
    desc: Build all binaries.
    deps: [golang:golang-builder]
    cmds:
      - docker run --rm -v {{.PROJECT_DIR}}:/go/src/{{.PROJECT}} -v /var/run/docker.sock:/var/run/docker.sock -w /go/src/{{.PROJECT}}/modules/{{.NAME}} --cap-add=IPC_LOCK --ulimit memlock=-1:-1 x6adev/golang-builder:latest _build-all
      - sudo chown -R {{.LOCAL_UID}}:{{.LOCAL_GID}} .

  build-node:
    desc: Build the node binary.
    deps: [golang:golang-builder]
    cmds:
      - docker run --rm -v {{.PROJECT_DIR}}:/go/src/{{.PROJECT}} -v /var/run/docker.sock:/var/run/docker.sock -w /go/src/{{.PROJECT}}/modules/{{.NAME}} --cap-add=IPC_LOCK --ulimit memlock=-1:-1 x6adev/golang-builder:latest _build-node
      - sudo chown -R {{.LOCAL_UID}}:{{.LOCAL_GID}} .

  clean:
    desc: Clean everything.
    deps: [golang:go-clean, docker:docker-images-clean]
    cmds:
      - echo 'Cleaning dist working directory...'
      - rm -rf {{.DIST_DIR}}

  docker-build-node:
    desc: docker build -- mmesh-node
    # deps: [build-node]
    cmds:
    - task: docker:docker-build
      vars: {IMAGE: "mmesh-node", DIR: "_dist/mmesh-node_linux_amd64", DOCKERFILE: "./build/package/dockerfiles/dockerfile-node"}

  docker-push-node-dev:
    desc: docker push -- mmesh-node (dev build)
    deps: [docker-build-node]
    cmds:
    - task: docker:docker-push
      vars: {IMAGE: "mmesh-node", VERSION: "snapshot", REPO: "mmeshdev", TAG: "dev"}
    - task: docker:image-scan
      vars: {IMAGE: "mmesh-node", REPO: "mmeshdev", TAG: "dev"}

  docker-push-node-stable:
    desc: docker push -- mmesh-node (stable build)
    deps: [docker-build-node]
    cmds:
    - task: docker:docker-push
      vars: {IMAGE: "mmesh-node", REPO: "mmeshdev", TAG: "stable"}
    - task: docker:image-scan
      vars: {IMAGE: "mmesh-node", REPO: "mmeshdev", TAG: "stable"}

  release-binaries-dev:
    desc: Release binaries (dev build)
    dir: '{{.PREFIX}}'
    cmds:
      - ./scripts/_local/build/pkg-upload.sh '{{.DIST_DIR}}/mmesh-node_{{.VERSION}}_linux_amd64.deb' '{{.PKG_REPO_DEV}}'
      - ./scripts/_local/build/pkg-upload.sh '{{.DIST_DIR}}/mmesh-node_{{.VERSION}}_linux_amd64.rpm' '{{.PKG_REPO_DEV}}'
      - ./scripts/_local/build/release.sh '{{.VERSION}}' '{{.DIST_DIR}}' '{{.GS_BUCKET}}' 'dev'

  release-binaries-stable:
    desc: Release binaries (stable build)
    dir: '{{.PREFIX}}'
    cmds:
      - ./scripts/_local/build/pkg-upload.sh '{{.DIST_DIR}}/mmesh-node_{{.VERSION}}_linux_amd64.deb' '{{.PKG_REPO}}'
      - ./scripts/_local/build/pkg-upload.sh '{{.DIST_DIR}}/mmesh-node_{{.VERSION}}_linux_amd64.rpm' '{{.PKG_REPO}}'
      - ./scripts/_local/build/release.sh '{{.VERSION}}' '{{.DIST_DIR}}' '{{.GS_BUCKET}}' 'stable'

  release-all-dev:
    desc: Release docker images and binaries (dev build)
    cmds:
      - task: docker-push-node-dev
      - task: release-binaries-dev

  release-all-stable:
    desc: Release docker images and binaries (stable build)
    cmds:
      # - task: docker-push-node-stable
      - task: release-binaries-stable

  goreleaser:
    desc: Build and release all the packages.
    deps: [docker:docker-login]
    cmds:
      - task: golang:go-generate
      - task: golang:go-fmt
      - task: golang:go-verify-vendor
      # - task: golang:go-vet
      # - task: golang:golangci-lint
      - task: git:update-git-repo
      - goreleaser release -f build/ci/goreleaser/release.yml --rm-dist
      - ./scripts/_local/build/gh-tag-delete.sh '{{.VERSION}}'
      - task: release-binaries-dev

includes:
  git: ./build/taskfiles/build/gitTasks.yml
  golang: ./build/taskfiles/build/golangTasks.yml
  docker: ./build/taskfiles/build/dockerTasks.yml
